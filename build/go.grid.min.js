/*! go.grid 2014-09-16 */
(function(){angular.module("go.grid.filters",[]),angular.module("go.grid.controllers",[]),angular.module("go.grid",["go.grid.controllers","go.grid.filters","angularLocalStorage"]),angular.module("go.grid").locales={en:{reset_settings:"Reset settings",columns:"Columns",checkbox_column:"Checkbox"},pl:{reset_settings:"Reset ustawieÅ„",columns:"Kolumny",checkbox_column:"Operacje grupowe"}},angular.module("go.grid").t=function(a){var b;return b=angular.module("go.grid").locales[angular.module("go.grid").locale||"en"],b&&b[a]?b[a]:a},angular.module("go.grid.filters").filter("translate",function(){return function(a){return angular.module("go.grid").t(a)}}),angular.module("go.grid.controllers").controller("goGridController",["$scope",function(a){var b,c;return a.columnsDef=[],a.columns=[],a.viewParams={sort_by:[],page:1,pageSize:1,length:0,filtersVisible:!0,filters:{},sort_columns:{}},c=0,a.startMeasure=function(){return console.log("start test"),c=(new Date).getTime()},a.endMeasure=function(){return console.log((new Date).getTime()-c)},a.highlight=function(b){return a.highlighted=b,a.onSelect?a.onSelect(b):void 0},a.filter=function(){var b,c,d,e;if(c=a.viewParams.filters,d=a.source,c){for(e in c)b=c[e],(b.type="text"&&b.exp)&&(d=d.filter(function(a){var c,d,e,f,g;for(d=[],g=b.fields,e=0,f=g.length;f>e;e++)c=g[e],d.push(a[c]);return b.exp.test(d.join(" "))}));d.length<a.viewParams.length&&(a.viewParams.page=1),a.viewParams.length=d.length}return a.filtered=d,a.sort(),a.viewParams.infinite?a.infinite():void 0},b=function(a,b){return b&&a[b]?$.isNumeric(a[b])?("0000000000000000000000000"+a[b]).slice(-24):a[b].toLowerCase():""},a.sort=function(){var c,d;return c=a.filtered,a.viewParams.sort_by.length&&(d=a.viewParams.sort_by[0].column,c=c.sort(function(a,c){var e,f;return e=b(a,d),f=b(c,d),e>f?1:f>e?-1:0}),a.filtered=a.viewParams.sort_by[0].direction<0?c.reverse():c),!0},a.infinite=function(){var b,c,d;return c=a.filtered,a.viewParams.infinite&&(d=0,parseInt(a.viewParams.page)>2&&(d=(parseInt(a.viewParams.page)-2)*a.viewParams.pageSize),0>d&&(d=0),b=(parseInt(a.viewParams.page)+1)*a.viewParams.pageSize,c=c.slice(d,b)),a.truncated=c}}]),angular.module("go.grid").directive("goGrid",["$compile","$parse","$timeout","storage","$interpolate",function(a,b,c,d,e){return{restrict:"A",scope:!0,controller:"goGridController",compile:function(f,g){var h;return h=d.get(g.name+".columns")||{},function(f,g,i){var j,k,l,m,n,o,p;m=[];for(l in h)j=h[l],m[j.index]=null;for(p=f.columnsDef,n=0,o=p.length;o>n;n++)j=p[n],k=h[j.name],k&&null!=k.index?(m[k.index]=$.extend({},j),m[k.index].visible=k.visible,k.width&&(m[k.index].width=k.width)):m.push(j);return f.columns=m.filter(function(a){return a}),f.exportCSV=function(){var a,b,d,g,i,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;for(s={},h=[],D=f.columns,k=v=0,y=D.length;y>v;k=++v)j=D[k],j.visible&&"checkbox"!==j.type&&h.push({header:j.header,index:k,field:j.name,template:j.template,width:j.width});for(i=0,g=[],w=0,z=h.length;z>w;w++)d=h[w],b=XLSX.utils.encode_cell({c:i,r:0}),a={v:d.header,t:"s"},s[b]=a,i++,g.push({wpx:d.width});for(s["!cols"]=g,n=1,m=0,(u=XLSX.SSF._table)[50]||(u[50]="YYYY/MM/DD"),E=f.source,k=x=0,A=E.length;A>x;k=++x){for(l=E[k],i=0,C=0,B=h.length;B>C;C++)d=h[C],b=XLSX.utils.encode_cell({c:i,r:n}),a={v:l[d.field],t:"s"},$.isNumeric(a.v)?a.t="n":moment(l[d.field]).isValid()&&null!=l[d.field]&&(a.t="n",a.z=XLSX.SSF._table[50],a.v=(moment(l[d.field]).toDate()-new Date(Date.UTC(1899,11,30)))/864e5),d.template&&"s"===a.t&&(a.v=e(d.template)({item:l}).replace(/(<([^>]+)>)/gi,"").trim(),a.h=e(d.template)({item:l})),s[b]=a,i>m&&(m=i),i++;n++}return s["!ref"]=XLSX.utils.encode_range({s:{c:0,r:0},e:{c:m,r:n-1}}),t="export",q={SheetNames:[t],Sheets:{}},q.Sheets[t]=s,r=XLSX.write(q,{bookType:"xlsx",bookSST:!0,type:"binary"}),o=function(a){var b,c,d,e,f;for(b=new ArrayBuffer(a.length),d=new Uint8Array(b),k=f=0,e=a.length;e>f;k=++f)c=a[k],d[k]=255&a.charCodeAt(k);return b},p=o(r),c(function(){return saveAs(new Blob([p],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),"20320389233test.xlsx")},500),!0},f.$watch("columns",function(){var a,b,c,e,g;for(a={},g=f.columns,b=c=0,e=g.length;e>c;b=++c)j=g[b],a[j.name]={visible:j.visible,width:j.width,index:b};return d.set(i.name+".columns",a)},!0),f.name=i.name,f.onSelect=f[i.onSelect.replace("()","")],f.source=b(i.source)(f),f.filtered=f.source,f.viewParams.infinite=null!=i.infinite,f.sort(),f.resetStorage=function(){return f.columns=f.columnsDef,d.set(i.name+".columns",null),!0},f.viewParams.infinite?(f.$watch("source",function(){return f.viewParams.length=f.source.length}),f.$watch("viewParams.pageSize",function(a,b){return a!==b?f.infinite():void 0}),f.$watch("viewParams.length",function(){return c(function(){var a;return a=$(g).find(".go-grid-table-body td").height()||30,$(g).find(".go-grid-table-body > div").height(f.viewParams.length*a),$(g).find(".go-grid-table-body").scrollTop(0)},10)}),f.$watch("viewParams.page",function(){var a,b;return parseInt(f.viewParams.page)>2?(b=($(g).find(".go-grid-table-body table td ").height()||30)+1,a=b*f.viewParams.pageSize*(parseInt(f.viewParams.page)-2),$(g).find(".go-grid-table-body > div").css({paddingTop:a})):$(g).find(".go-grid-table-body > div").css({paddingTop:0})})):f.truncated=f.filtered,g.html("<div ng-include=\"'grid_base.html'\"></div>"),a(g.contents())(f)}}}}]).directive("column",[function(){return{restrict:"E",link:function(a,b,c){return a.columnsDef.push({name:c.name,width:c.width,header:c.header,sort:c.sort,sortable:null!=c.sort,visible:null==c.hidden,resizable:null!=c.resize&&$().resizablee,template:b.html(),right:null!=c.right}),null!=c.sortDefault?(a.viewParams.sort_by=[{column:c.sort||c.name,direction:1}],a.viewParams.sort_columns={},a.viewParams.sort_columns[c.sort||c.name]=1):void 0}}}]).directive("filters",["$compile",function(){return{restrict:"E",link:function(a,b){return a.filters=[],a.filtersTpl=b.html()}}}]).directive("filtersContainer",["$compile",function(a){return{restrict:"A",compile:function(){return function(b,c){return c.html("<div ng-include=\"'filters_container.html'\"></div>"),c.append(b.filtersTpl),a(c.contents())(b)}}}}]).directive("searchFilter",["$compile",function(a){return{restrict:"E",link:function(b,c,d){var e,f,g;return e='<input class="form-control" ng-model="viewParams.filters.'+d.name+'.value" />',((f=b.viewParams).filters||(f.filters={}))[d.name]?void 0:(b.$watch("viewParams.filters."+d.name+".value",function(a,c){var e,f;if(a!==c){f=b.viewParams.filters[d.name].value.replace("%","(.)+"),f="(?=.*"+f.split("&").join(")(?=.*")+")";try{b.viewParams.filters[d.name].exp=new RegExp("("+f+")","i")}catch(g){e=g}return b.filter()}}),((g=b.viewParams).filters||(g.filters={}))[d.name]={type:"text",fields:d.fields.split(","),name:d.name,value:""},c.html(e),a(c.contents())(b))}}}]).directive("columnHeader",["$compile",function(){var a;return a=function(a,b,c){var d;return d=a.filter(function(a){return a[b]===c})[0],d||!1},{restrict:"A",templateUrl:"grid_column.html",link:function(b,c){var d;return b.column.right&&c.addClass("text-right"),"checkbox"===b.column.type?(c.html('<div style="width: '+b.column.width+'px; padding: 0 0 0 6px"><input type="checkbox" class="checkbox" /></div>'),c.find("input").on("click",function(){var a;return a=$(this).prop("checked")?!0:!1,b.$apply(function(){var c,d,e,f,g;for(f=b.source,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(c[b.column.field]=a);return g}),!0})):(b.column.resizable&&$(c).children("div").resizable({handles:"e",stop:function(){return b.$parent.$broadcast("columnResize"),b.$apply(function(a){return function(){return b.column.width=$(a).width()+8}}(this))}}),b.column.sortable?(c.addClass("sortable"),d=b.column.sort||b.column.name,$(c).on("click",function(c){return b.startMeasure(),b.$apply(function(){var c,e,f;return e=a(b.viewParams.sort_by,"column",d),c=e?e.direction:-1,b.viewParams.sort_by=[],(f=b.viewParams.sort_by)[0]||(f[0]={}),b.viewParams.sort_by[0].column=d,b.viewParams.sort_by[0].direction=-1*c,b.viewParams.sort_columns={},b.viewParams.sort_columns[d]=-1*c,b.sort(),b.infinite()}),c.preventDefault(),!1})):void 0)}}}]).directive("checkboxColumn",[function(){return{restrict:"E",link:function(a,b,c){return a.columnsDef.push({field:c.field,visible:null==c.hidden,width:c.width,header:angular.module("go.grid").t("checkbox_column"),type:"checkbox",name:c.name||"checkbox",template:'<input type="checkbox" class="checkbox" ng-model="item.'+c.field+'" />'})}}}]).directive("goCell",["$compile",function(a){return{restrict:"A",compile:function(){return function(b,c){var d,e;return e=b.column.template,""===e&&(e="{{item[column.name]}}"),d=[],b.column.right&&d.push("text-right"),e='<div ng-style="{width: column.width}" class="'+d.join(" ")+'">'+e+"</div>",c.html(e),a(c.contents())(b),c.on("click",function(){return function(a){return b.editing=!0,"checkbox"===b.column.type?a.stopPropagation():void 0}}(this))}}}}]).directive("scrollTable",["$timeout",function(a){return{restrict:"A",link:function(b,c){var d,e,f,g;return e=c.parent().find(".go-grid-table-header"),d=function(){var a;return a=($(c).find("td ").height()||30)+1,b.viewParams.pageSize=Math.round($(c).height()/a)},$(window).resize(function(){return d()}),g=function(){var a,b,f;return a=c.parent().find(".go-grid-filters"),f=e.height(),b=a.height()+8,c.css({top:f+b}),d()},a(function(){return g()},10),b.$on("columnResize",function(){return g()}),f=c.scrollTop(),c.on("scroll",function(){var a,d;return e.scrollLeft($(this).scrollLeft()),f!==c.scrollTop()&&(f=c.scrollTop(),d=($(c).find("td ").height()||30)+1,b.viewParams.infinite&&(a=Math.round($(this).scrollTop()/d/b.viewParams.pageSize)+1,a!==b.viewParams.page))?b.$apply(function(){return function(){return b.viewParams.page=a,b.viewParams.page<0&&(b.viewParams.page=0),b.viewParams.page>b.source.length/b.viewParams.pageSize&&(b.viewParams.page=Math.round(b.source.length/b.viewParams.pageSize)),b.infinite()}}(this)):void 0})}}}]).directive("columnConfig",[function(){return{restrict:"E",replace:!0,template:['<div class="column-config">','<a class="checkbox-link" href="javascript:void(0)" ng-click="column.visible = !column.visible">'," <span class=\"fa\" ng-class=\"{'fa-check-square-o': column.visible, 'fa-square-o': !column.visible}\">","</span>"," {{column.header }}","</a>",'<div class="sort-icons">','<span class="fa fa-chevron-up" ng-click="moveColumnUp()"></span><span class="fa fa-chevron-down" ng-click="moveColumnDown()"></span>',"</div>","</div>"].join(""),link:function(a,b){return a.moveColumnUp=function(){var b;return b=a.columns.indexOf(a.column),b>=0?a.columns.moveUp(b):void 0},a.moveColumnDown=function(){var b;return b=a.columns.indexOf(a.column),b>=0?a.columns.moveDown(b):void 0},$(b).find("a").on("click",function(a){return a.preventDefault(),!1}),$(b).find("span.fa").on("click",function(a){return a.preventDefault(),!1})}}}]).run(["$templateCache",function(a){return a.put("grid_column.html",'<div ng-style="{width: column.width}"><span class="header-label">{{ column.header }}</span><span ng-if="column.sortable" class="sorting-arrows fa" ng-class="{\'fa-unsorted\': !viewParams.sort_columns[column.name], \'fa-sort-up\': viewParams.sort_columns[column.name] == 1, \'fa-sort-desc\': viewParams.sort_columns[column.name] == -1}"></span></div>'),a.put("filters_container.html",'<div class="go-grid-column-list btn-group"><button class="btn btn-default" type="button" data-toggle="dropdown"><span class="fa fa-cogs"></span></button><ul class="dropdown-menu pull-right" role="menu"><li><a href="javascript:void(0)" ng-click="resetStorage()">{{\'reset_settings\' | translate }}</a></li><li class="dropdown-header"><strong>{{\'columns\' | translate }}</strong></li><li ng-repeat="(index, column) in columns"><column-config></column-config></li></ul><button class="btn btn-default" ng-click="exportCSV()"><span class="fa fa-cloud-download"></span></button></div>'),a.put("grid_base.html",'<div class="go-grid-table"><div class="go-grid-filters form-inline" ng-if="viewParams.filtersVisible" filters-container></div><div class="go-grid-table-header"><table><thead><th column-header ng-repeat="column in columns" column="column" ng-if="column.visible"></th><th style="width: 100%; min-width: 50px"></th></thead></table></div><div class="go-grid-table-body" scroll-table><div><table><tbody><tr ng-repeat="item in truncated track by $index" ng-class="{active: item.active, selected: item.selected, highlighted: item == highlighted}" ng-click="highlight(item)"><td ng-repeat="column in columns" go-cell ng-if="column.visible"></td><td style="width: 100%"></td></tr></tbody></table></div></div></div>\n')}]).directive("watchCount",function(){return{restrict:"A",link:function(a,b){var c,d;return c=function(a,b){var d,e,f,g,h;for(e=angular.element(a),b[e.scope().$id]=e.scope(),h=e.children(),f=0,g=h.length;g>f;f++)d=h[f],c(d,b);return b},d=function(b){var c,d;c=0;for(d in b)a=b[d],a.$$watchers&&(c+=a.$$watchers.length);return c},$(b).click(function(){var a;return a=d(c("body",{})),$(b).html("Count: "+a)})}}})}).call(this);